.merge_request_rule: &merge_request_rule
  if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

.main_branch_rule: &main_branch_rule
  if: '$CI_COMMIT_BRANCH == "main"'

stages:
  - static-test
  - dynamic-test
  - deploy

# --- Default pipeline run ---
running_pipelines:
  stage: static-test
  rules:
    - <<: *merge_request_rule
      changes:
        - docker-compose.yml
        - .gitlab-ci.yml
        - Makefile
        - Readme.md
        - .gitignore
        - seeder/**/*
        - nginx/*
  script:
    - echo "Running pipelines"

# --- Static Tests ---
lint_vibe_client:
  stage: static-test
  image: node:18
  rules:
    - <<: *merge_request_rule
      changes:
        - vibe-client/**/*
  script:
    - cd vibe-client
    - npm install eslint@9.21.0
    - npx eslint

lint_vibe_server:
  stage: static-test
  image: node:18
  rules:
    - <<: *merge_request_rule
      changes:
        - vibe-server/**/*
  script:
    - cd vibe-server
    - npm install eslint@9.26.0
    - npm run lint

audit_vibe_client:
  stage: static-test
  image: node:18
  rules:
    - <<: *merge_request_rule
      changes:
        - vibe-client/**/*
  script:
    - cd vibe-client
    - npm audit

audit_vibe_server:
  stage: static-test
  image: node:18
  rules:
    - <<: *merge_request_rule
      changes:
        - vibe-server/**/*
  script:
    - cd vibe-server
    - npm audit

# --- Dynamic Tests ---
build_vibe_client:
  stage: dynamic-test
  image: node:18
  rules:
    - <<: *merge_request_rule
      changes:
        - vibe-client/**/*
  script:
    - echo "Building vibe-client"
    - cd vibe-client
    - npm install
    - npm run build

build_vibe_server:
  stage: dynamic-test
  image: node:18
  rules:
    - <<: *merge_request_rule
      changes:
        - vibe-server/**/*
  script:
    - echo "Building vibe-server"
    - cd vibe-server
    - npm install
    - npm run build

# --- Deploy (Continuos Delivery) ---
deploy_client_to_render:
  stage: deploy
  image: curlimages/curl:latest
  when: manual
  allow_failure: false
  rules:
    - <<: *main_branch_rule
      changes:
        - vibe-client/**/*
  script:
    - echo "Triggering client deployment to Render..."
    - curl -X POST "$RENDER_DEPLOY_CLIENT_HOOK_URL"

deploy_server_to_render:
  stage: deploy
  image: curlimages/curl:latest
  when: manual
  allow_failure: false
  rules:
    - <<: *main_branch_rule
      changes:
        - vibe-server/**/*
  script:
    - echo "Triggering server deployment to Render..."
    - curl -X POST "$RENDER_DEPLOY_SERVER_HOOK_URL"
