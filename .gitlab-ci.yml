.merge_request_rule: &merge_request_rule
  if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

stages:
  - static-test
  - dynamic-test

running_pipelines:
  stage: static-test
  rules:
    - <<: *merge_request_rule
      changes:
        - docker-compose.yml
        - .gitlab-ci.yml
        - Makefile
        - Readme.md
        - .gitignore
        - seeder/**/*
  script:
    - echo "Running pipelines"

lint_vibe_client:
  stage: static-test
  image: node:18
  rules:
    - <<: *merge_request_rule
      changes:
        - vibe-client/**/*
  script:
    - cd vibe-client
    - npm install eslint@9.21.0
    - npx eslint

lint_vibe_server:
  stage: static-test
  image: node:18
  rules:
    - <<: *merge_request_rule
      changes:
        - vibe-server/**/*
  script:
    - cd vibe-server
    - npm install eslint@9.21.0
    - npx eslint

audit_vibe_client:
  stage: static-test
  image: node:18
  rules:
    - <<: *merge_request_rule
      changes:
        - vibe-client/**/*
  script:
    - cd vibe-client
    - npm audit

audit_vibe_server:
  stage: static-test
  image: node:18
  rules:
    - <<: *merge_request_rule
      changes:
        - vibe-server/**/*
  script:
    - cd vibe-server
    - npm audit

build_vibe_client:
  stage: dynamic-test
  image: node:18
  rules:
    - <<: *merge_request_rule
      changes:
        - vibe-client/**/*
  script:
    - echo "Building vibe-client"
    - cd vibe-client
    - npm install
    - npm run build
